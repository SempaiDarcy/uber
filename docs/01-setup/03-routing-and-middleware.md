# Роуты и middleware в Express

В данном разделе объясняется, как Express обрабатывает входящие HTTP-запросы,
что такое middleware, и какую роль играют роуты.

Разбор приведён на концептуальном уровне — без привязки к бизнес-логике.

---

## Общая модель обработки запроса

Express обрабатывает каждый HTTP-запрос последовательно,
проходя по цепочке функций.

Упрощённая схема:

```text
Запрос
  ↓
middleware (app.use)
  ↓
middleware (app.use)
  ↓
route handler (app.get / app.post / ...)
  ↓
Ответ
```

Middleware и роуты **не вызываются вручную**.
Они регистрируются заранее и выполняются Express автоматически
при поступлении запроса.

---

## Middleware

### Что такое middleware

Middleware — это функция, которая:

- выполняется **до роута**
- имеет доступ к объектам `req` и `res`
- может изменить запрос или ответ
- может передать управление следующему обработчику

Типичная сигнатура middleware:

```ts
(req, res, next) => { ... }
```

Параметр `next` — это функция, передающая управление
следующему middleware или роуту.

---

### app.use — добавление middleware в конвейер

Метод `app.use` используется для регистрации middleware.

```ts
app.use((req, res, next) => {
  console.log(req.method, req.url);
  next();
});
```

Смысл данного кода:

- middleware будет выполняться **на каждый запрос**
- выводит HTTP-метод и URL
- после выполнения передаёт управление дальше с помощью `next()`

Если `next()` не вызвать, обработка запроса остановится.

---

### Пример: express.json()

```ts
app.use(express.json());
```

`express.json()` — это встроенный middleware Express.

Он:

- читает тело HTTP-запроса
- парсит JSON
- записывает результат в `req.body`
- передаёт управление дальше

Без этого middleware `req.body` будет `undefined`.

---

## Роуты

### Что такое роут

Роут — это правило обработки HTTP-запроса,
привязанное к методу и пути.

Пример:

```ts
app.get("/", (req, res) => {
  res.status(200).send("Hello world!");
});
```

Это означает:

- если придёт запрос `GET /`
- будет выполнена указанная функция
- клиенту будет отправлен ответ

---

### Отличие middleware от роутов

| Middleware | Роут |
|----------|------|
| `app.use` | `app.get / post / put / delete` |
| Выполняется до роутов | Выполняется при совпадении пути |
| Может быть для всех методов | Привязан к HTTP-методу |
| Служебная логика | Бизнес-логика |

---

## Итоговая модель

Коротко:

```text
app.use  → добавляет функцию в конвейер
middleware → изменяет req / res
next() → передаёт управление дальше
app.get/post → регистрирует правило маршрута
```

Понимание этой модели устраняет ощущение "магии" в Express
и позволяет осознанно управлять порядком обработки запросов.
